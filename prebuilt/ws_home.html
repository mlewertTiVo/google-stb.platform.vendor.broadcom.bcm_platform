<!DOCTYPE html>
<html lang="en">
<head>
 <!--meta charset=utf-8 /-->
<meta name="viewport" content="minimum-scale=1.0, maximum-scale=1.0,
	width=device-width, user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <title>Broadcom Android STB Web Remote</title>
 <style type="text/css">
	
	#remote
	{

	}
	input
	{

		width: 75px;
		height: 50px;
		border-radius: 200px;
		-webkit-appearance: none;
		background: -webkit-gradient(linear, left top, left bottom, from(#ed1c24), to(#aa1317));
		color: white;
		
	}
	#remoteScreen
	{
		position: absolute;
	}
	#swipeBox
	{
	position: absolute;
	top: 10px;
	left: 1px;
	width: 1020px;
	height: 570px;
	background:rgba(255, 255, 255, .15); 
	z-index: 11;
	}

	
	BODY
	{
		background: rgba(0,0,0,1);
	
	}
	
	#backBtn
	{
		position: absolute;
		width: 130px;
		height: 50px;
		font-size: x-large;
		left: 10px;
		top: 600px;
		background:rgba(155, 155, 255, .70);
	}
	/*
	#homeBtn
	{
		position: absolute;
		width: 130px;
		height: 50px;
		font-size: x-large;
		left: 150px;
		top: 600px;
		background:rgba(155, 155, 255, .70);
	}
	#switchBtn
	{
		position: absolute;
		width: 150px;
		height: 50px;
		font-size: x-large;
		left: 290px;
		top: 600px;
		background:rgba(155, 155, 255, .70);
	}
	*/
	#menuBtn
	{
		position: absolute;
		width: 130px;
		height: 50px;
		font-size: x-large;
		left: 150px;
		top: 600px;
		background:rgba(155, 155, 255, .70);
	}

	
	@media only screen and (orientation:portrait){
   /* portrait styles here */
	#swipeBox
	{
	position: absolute;
	top: 10px;
	left: 1px;
	width: 770px;
	height: 830px;
	background:rgba(255, 255, 255, .15); 
	-webkit-transition-duration: .350s;
	}

	#backBtn
	{
		position: absolute;
		width: 130px;
		height: 50px;
		font-size: x-large;
		left: 10px;
		top: 860px;
		background:rgba(155, 155, 255, .70);
	}
	/*
	#homeBtn
	{
		position: absolute;
		width: 130px;
		height: 50px;
		font-size: x-large;
		left: 150px;
		top: 600px;
		background:rgba(155, 155, 255, .70);
	}
	#switchBtn
	{
		position: absolute;
		width: 150px;
		height: 50px;
		font-size: x-large;
		left: 290px;
		top: 600px;
		background:rgba(155, 155, 255, .70);
	}
	*/
	#menuBtn
	{
		position: absolute;
		width: 130px;
		height: 50px;
		font-size: x-large;
		left: 150px;
		top: 860px;
		background:rgba(155, 155, 255, .70);
	}
}
 
 </style>
</head>

<body>
	
<div id=wsdi_statustd><div id=wsdi_status>Not initialized</div></div>


<table>
	<tr>
		<td width=100 align=center><div id=number> </div></td>	
	</tr>

</table>


	<div id="swipeBox" ontouchstart="touchStart(event,'swipeBox');"  ontouchend="touchEnd(event);" ontouchmove="touchMove(event);" ontouchcancel="touchCancel(event);" onclick="click();" > 
</div>

<div id="nav">
<input type=button id=backBtn value="BACK" onclick="onKeyBack();" >
<!--
<input type=button id=homeBtn value="HOME" onclick="onKeyHome();" >
<input type=button id=switchBtn value="SWITCH" onclick="onKeySwitch();" >
-->
<input type=button id=menuBtn value="MENU" onclick="onKeyMenu();" >
</div>


<div id="mouseBox" onmousemove="getPosition" ontouchstart="mouseStart(event,'mouseBox');"></div>

<div id="diagnosticScreen">
        <div id="satStatus" >
        <h2> Status (SDS) </h2>
        <table id="statusSDS" class="satStats"  >
        <tr><th>DemodLock:</th><td id="demodlock0">#</td></tr>
        <tr><th>Modulation:</th><td id="mode0">######</td></tr>
        <tr><th>SymbolRate:</th><td id="symbolrate0">#</td></tr>
        <tr><th>TunerFreq:</th><td id="tunerfreq0">#</td></tr>
        <tr><th>SNR:</th><td id="snr0">#</td></tr>
        <tr><th>OBR:</th><td id="obr0">#</td></tr>
        <tr><th>TimeElapsed:</th><td id="timeElapsed0">#</td></tr>

        </table>

        </div>


 <canvas id="constellation0" class="constellationGraph" width="300" height="300">[No canvas support]</canvas>
</div>



<script>
	
	function getPosition(e) {
		alert("click");
		  var _x;
		var _y;
			_x = e.pageX;
    _y = e.pageY;
		alert("Cords: " + _x + "," + _y); 
	}
	
	var remoteActive = true;
	
	var pos = 0;
	var time = -10000;
	
	function mouseStart(event, passedName) {
		var mouseX = event.touches[0].pageX;
		var mouseY = event.touches[0].pageY;
		var left = getOffset(document.getElementById(passedName)).left;
		var top =  getOffset(document.getElementById(passedName)).top;
		var height = document.getElementById(passedName).offsetHeight;
		var width = document.getElementById(passedName).offsetWidth;
		onMouseMoving(mouseX, mouseX);
		alert("height, width: " + height + "," + width);
		alert("(X,Y): ("+ (mouseX  - left) + "," + (mouseY - top) + ")");
	}
	
	function getOffset( el ) {
    var _x = 0;
    var _y = 0;
    while( el && !isNaN( el.offsetLeft ) && !isNaN( el.offsetTop ) ) {
        _x += el.offsetLeft - el.scrollLeft;
        _y += el.offsetTop - el.scrollTop;
        el = el.offsetParent;
    }
    return { top: _y, left: _x };
}
	
	
	/*****************************/
	// TOUCH-EVENTS SINGLE-FINGER SWIPE-SENSING JAVASCRIPT
	// Courtesy of PADILICIOUS.COM and MACOSXAUTOMATION.COM
	var triggerElementID = null; // this variable is used to identity the triggering element
			var fingerCount = 0;
			var startX = 0;
			var startY = 0;
			var curX = 0;
			var curY = 0;
			var deltaX = 0;
			var deltaY = 0;
			var horzDiff = 0;
			var vertDiff = 0;
			var minLength = 72; // the shortest distance the user may swipe
			var swipeLength = 0;
			var swipeAngle = null;
			var swipeDirection = null;
			var border_scroll_x = 0;
	
	function touchStart(event,passedName) {
				var now = new Date();
				//alert(now.getTime());
				//if(now.getTime() - time < 200)
					//socket_di.send(RemoteCommands.OK);
				time = now.getTime();		
				// disable the standard ability to select the touched object
				event.preventDefault();
				// get the total number of fingers touching the screen
				fingerCount = event.touches.length;
				// since we're looking for a swipe (single finger) and not a gesture (multiple fingers),
				// check that only one finger was used
				if ( fingerCount == 1 ) {
					// get the coordinates of the touch
					startX = event.touches[0].pageX;
					startY = event.touches[0].pageY;
					// store the triggering element ID
					triggerElementID = passedName;
					socket_di.send("onTouchStart");
				} else {
					//alert(fingerCount);
					// more than one finger touched so cancel
					//alert("twoFinger");
					touchCancel(event);
				}
			}
		
			function touchMove(event) {
				event.preventDefault();
				curX = event.touches[0].pageX;
				curY = event.touches[0].pageY;
				if ( event.touches.length == 1 ) {
					if(window.innerHeight < window.innerWidth){
						border_scroll_x = 950;
					}
					else{
						border_scroll_x = 700;
					}
						
					if(curX > border_scroll_x)
						onScrolling(curY);
					else
						onMouseMoving(curX, curY);
				} else if(event.touches.length == 2){
					//alert("twoFinger");
					//touchCancel(event);
					onTwoFingers();
					if(curX > 900)
						onScrolling(curY);
					else
						onMouseMoving(curX, curY);
				} else {
					alert("Not support more than 2 fingers");
				}
			}
			
			function touchEnd(event) {
				event.preventDefault();
				// check to see if more than one finger was used and that there is an ending coordinate
				if ( fingerCount == 1 && curX != 0 ) {
					// use the Distance Formula to determine the length of the swipe
					swipeLength = Math.round(Math.sqrt(Math.pow(curX - startX,2) + Math.pow(curY - startY,2)));
					// if the user swiped more than the minimum length, perform the appropriate action
					if ( swipeLength >= minLength ) {
						caluculateAngle();
						determineSwipeDirection();
						//processingRoutine();
						touchCancel(event); // reset the variables
					} else {
						touchCancel(event);
					}	
				} else {
					touchCancel(event);
				}
				socket_di.send("onTouchEnd");
			}
		
			function touchCancel(event) {
				// reset the variables back to default values
				fingerCount = 0;
				startX = 0;
				startY = 0;
				curX = 0;
				curY = 0;
				deltaX = 0;
				deltaY = 0;
				horzDiff = 0;
				vertDiff = 0;
				swipeLength = 0;
				swipeAngle = null;
				swipeDirection = null;
				triggerElementID = null;
			}
			
			function caluculateAngle() {
				var X = startX-curX;
				var Y = curY-startY;
				var Z = Math.round(Math.sqrt(Math.pow(X,2)+Math.pow(Y,2))); //the distance - rounded - in pixels
				var r = Math.atan2(Y,X); //angle in radians (Cartesian system)
				swipeAngle = Math.round(r*180/Math.PI); //angle in degrees
				if ( swipeAngle < 0 ) { swipeAngle =  360 - Math.abs(swipeAngle); }
			}
			
			function determineSwipeDirection() {
				if ( (swipeAngle <= 45) && (swipeAngle >= 0) ) {
					swipeDirection = 'left';
				} else if ( (swipeAngle <= 360) && (swipeAngle >= 315) ) {
					swipeDirection = 'left';
				} else if ( (swipeAngle >= 135) && (swipeAngle <= 225) ) {
					swipeDirection = 'right';
				} else if ( (swipeAngle > 45) && (swipeAngle < 135) ) {
					swipeDirection = 'down';
				} else {
					swipeDirection = 'up';
				}
			}
			
			function processingRoutine() {
				var swipedElement = document.getElementById(triggerElementID);
				if ( swipeDirection == 'left' ) {
					socket_di.send(RemoteCommands.LEFT);
				} else if ( swipeDirection == 'right' ) {
					socket_di.send(RemoteCommands.RIGHT);
				} else if ( swipeDirection == 'up' ) {
					socket_di.send(RemoteCommands.UP);
				} else if ( swipeDirection == 'down' ) {
					socket_di.send(RemoteCommands.DOWN);
				}
			}
	
	/****************END SWIPE CODE****************/
	
	
	
	
function get_appropriate_ws_url()
{
	var pcol;
	var u = document.URL;

	/*
	 * We open the websocket encrypted if this page came on an
	 * https:// url itself, otherwise unencrypted
	 */

	if (u.substring(0, 5) == "https") {
		pcol = "wss://";
		u = u.substr(8);
	} else {
		pcol = "ws://";
		if (u.substring(0, 4) == "http")
			u = u.substr(7);
	}

	u = u.split('/');

	return pcol + u[0];
}


document.getElementById("number").textContent = get_appropriate_ws_url();

/* dumb increment protocol */

	var android_webkit = 0;

	try {
		var socket_di = new WebSocket(get_appropriate_ws_url(),
					   "remote-protocol");  
	} catch (exception)
	{
		if (navigator.userAgent.match(/Android/i)) {
			socket_di.open(get_appropriate_ws_url());
			android_webkit = 1;
		}
	}

	if (android_webkit==0) {

		try {
			socket_di.onopen = function() {
				document.getElementById("wsdi_statustd").style.backgroundColor = "#40ff40";
				document.getElementById("wsdi_status").textContent = " websocket connection opened ";
			} 

			socket_di.onmessage =function got_packet(msg) {
				document.getElementById("number").textContent = msg.data + "\n";
			} 

			socket_di.onclose = function(){
				document.getElementById("wsdi_statustd").style.backgroundColor = "#ff4040";
				document.getElementById("wsdi_status").textContent = " websocket connection CLOSED ";
			}
		} catch(exception) {
			alert('<p>Error' + exception);  
		}
	}

RemoteCommands = {
	UP: "0",
	DOWN: "1",
	LEFT: "2",
	RIGHT: "3",
	OK: "4",
	MENU: "5",
	GUIDE: "6",
	INFO: "7",
	CHUP: "8",
	CHDWN: "9",
	EXIT: "10",
	REWIND: "11",
	FF: "12",
	PLAY: "13",
	STOP: "14",
	BACK: "15",
	FORWARD: "16",
	PAUSE: "17"
	}


function reset() {
	//socket_di.send("reset\n");
	socket_di.send(139);
}
function up() {
	socket_di.send(RemoteCommands.UP);
}
function down() {
	socket_di.send(RemoteCommands.DOWN);
}
function left() {
	socket_di.send(RemoteCommands.LEFT);
}
function right() {
	socket_di.send(RemoteCommands.RIGHT);
}
function ok() {
	socket_di.send(RemoteCommands.OK);
}
function menu() {
	socket_di.send(RemoteCommands.MENU);
}
function guide() {
	socket_di.send(RemoteCommands.GUIDE);
}
function info() {
	socket_di.send(RemoteCommands.INFO);
}
function exit() {
	socket_di.send(RemoteCommands.EXIT);
}
function onKeyBack() {
	socket_di.send("onKeyBack"+'\0');
}
function onKeyHome() {
	socket_di.send("onKeyHome"+'\0');
}
function onKeySwitch() {
	socket_di.send("onKeySwitch"+'\0');
}
function onKeyMenu() {
	socket_di.send("onKeyMenu"+'\0');
}
function forward() {
	socket_di.send(RemoteCommands.FORWARD);
}
function play() {
	socket_di.send(RemoteCommands.PLAY);
}
function rewind() {
	socket_di.send(RemoteCommands.BACK);
}
function ff() {
	socket_di.send(RemoteCommands.FF);
}
function stop() {
	socket_di.send(RemoteCommands.STOP);
}
function pause() {
	socket_di.send(RemoteCommands.PAUSE);
}

var MutableString = function(value) {
  this.text = value;
};
 
MutableString.prototype = {
  toString: function() {
    return this.text;
  }
};

function onScrolling(y) {
	var bytes = new MutableString("onScrolling"+'\0'+y+'\0');
	socket_di.send(bytes);
}

function onMouseMoving(x, y) {
	/*
	if(x>650){
		var bytes = new MutableString("onMouseMoveRight"+'\0'+(x-650)+'\0');
	}else{
		var bytes = new MutableString("onMouseMoveLeft"+'\0'+(650-x)+'\0');
	}
	socket_di.send(bytes);
	
	if(y>350){
		var bytes = new MutableString("onMouseMoveDown"+'\0'+(y-350)+'\0');
	}else{
		var bytes = new MutableString("onMouseMoveUp"+'\0'+(350-y)+'\0');
	}
	*/
	/*var bytes = new MutableString("onMouseMove"+'\0'+x+'\0'+y+'\0');
	socket_di.send(bytes);*/

        var bytes = new String("onMouseMove");
        var split_bytes=[bytes,x.toString(), y.toString()];
        var join_bytes=split_bytes.join();
        socket_di.send(join_bytes);
}

function onTwoFingers(){
	socket_di.send("onTwoFingers");
}

function diagnostics() {
	if(remoteActive) {
	document.getElementById("nav").style.opacity = 0;
	document.getElementById("playbackButtons").style.opacity = 0;
	document.getElementById("homeButtons").style.opacity = 0;
	document.getElementById("swipeBox").style.opacity = 0;
	document.getElementById("diagnosticScreen").className = "diagnosticsActive";
		document.getElementById("constellation0").className = "";
	document.getElementById("satStatus").className = ""
	toggleInterval(0);
	document.getElementById("diagnosticScreen").style.opacity = 1;
	document.getElementById("constellation0").style.opacity = 1;
	document.getElementById("satStatus").style.opacity = 1;
	remoteActive = false;
	}
}

function remote() {
    if(!remoteActive) {
		document.getElementById("diagnosticScreen").className = "diagnosticsHidden";

	document.getElementById("nav").style.opacity = 1;
	document.getElementById("playbackButtons").style.opacity = 1;
	document.getElementById("homeButtons").style.opacity = 1;
	document.getElementById("swipeBox").style.opacity = 1;

	/*
	document.getElementById("diagnosticScreen").style.opacity = 0;
	document.getElementById("constellation0").style.opacity = 0;
	document.getElementById("satStatus").style.opacity = 0; */
	toggleInterval(0);
	remoteActive = true;
	
	}
}



/* soft decisions */

var delay = 500;
var interval = false;
var samplesCount = 0;
var samples = new Array();


function getNewValue() 
{
    var numSamples = 16;
    var softDecision;
    var softDecisionObjects;
    if (cableFrontend) {
        softDecisionObjects = $Cable.getSoftDecision(numSamples);
    }
    else if (terFrontend) {
        softDecisionObjects = $Ter.getSoftDecision(numSamples);
    }
    else
    {
        softDecisionObjects = $Sat.getSoftDecision(numSamples);
    }
    for (var i = 0; i < softDecisionObjects.length; i++) 
    {
        softDecision = softDecisionObjects[i];
        if ((softDecision.i < 0) || (softDecision.i >= 256-1))
            continue;
        if ((softDecision.q < 1) || (softDecision.q >= 256-1))
            continue;
        //alert('i=' + softDecision.i + ', q=' + softDecision.q);
        var xy = new Array(softDecision.i + 1, softDecision.q + 1);

        samples[i] = xy;
        samplesCount++;

    }

    retVal = xy;
    return retVal;
}


function getNewValueSimulate() {
    var retVal;
    // get cs value
    for (var i = 0; i < 16; i++) {
        var x = Math.round(Math.random() * 300);
        var y = Math.round(Math.random() * 300);
        var xy = new Array(x, y);
        samples[i] = xy;
        samplesCount++;
    }

    retVal = xy;
    return retVal;
}

function initialDraw() {
    var myCanvas = document.getElementById("constellation0");
    var ctx = myCanvas.getContext('2d');
    ctx.clearRect(0, 0, myCanvas.width, myCanvas.height);

    drawGrid();
}



function drawGrid() {
    var myCanvas = document.getElementById("constellation0");
    var context = myCanvas.getContext("2d");

    //axis
    context.moveTo(0, 150);
    context.lineTo(300, 150);
    context.moveTo(150, 0);
    context.lineTo(150, 300);

    //borders 
	/*
    context.moveTo(0.5, 0);
    context.lineTo(0.5, 257);
    context.moveTo(256.5, 0);
    context.lineTo(256.5, 257);

    context.moveTo(0, 0.5);
    context.lineTo(257, 0.5);
    context.moveTo(0, 256.5);
    context.lineTo(257, 256.5);
*/

    //context.strokeStyle = "#2B2";
    context.strokeStyle = 'rgba(192, 42, 42, 1)';
	context.stroke();

}

function updateCharts() {
    getNewValueSimulate();
    //getNewValue();
    drawScatter();
}

function toggleInterval(channel) {
    if (interval) {
        clearInterval(interval);
        interval = false;
    }
    else {
        //var newValue = getNewValue();
        getNewValueSimulate();
        //getNewValue();
        initialDraw();
        interval = setInterval("updateCharts()", delay);
    }
}

function resetGraph() {
    samples = [];
    samples = new Array();
    samplesCount = 0;
    initialDraw();
}

function drawScatter() {
    if (samplesCount > 1000) {
        resetGraph();
		getNewValueSimulate();
        //getNewValue();
    }
    else {
        plotSamples();
    }
}


function plotSamples() {
    var myCanvas = document.getElementById("constellation0");
    var context = myCanvas.getContext("2d");
    for (var i = 0; i < 16; i++) {

   
        //context.fillStyle = 'rgba(172,42,42,.7)';
		context.fillStyle = 'rgba(255,255,255,1)';
        context.fillRect(samples[i][0], samples[i][1], 2, 2);

    }
}

function socket_di_onopen() {
	document.getElementById("wsdi_statustd").style.backgroundColor = "#40ff40";
	document.getElementById("wsdi_status").textContent = " websocket connection opened ";
} 

function socket_di_onmessage() {
	var msg = socket_di.getMessage();;
	document.getElementById("number").textContent = msg.data + "\n";
} 

function socket_di_onclose(){
	document.getElementById("wsdi_statustd").style.backgroundColor = "#ff4040";
	document.getElementById("wsdi_status").textContent = " websocket connection CLOSED ";
}



</script>

</body>
</html>
